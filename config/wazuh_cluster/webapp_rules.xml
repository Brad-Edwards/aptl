<!-- Web Application Detection Rules for APTL Lab -->
<group name="aptl,webapp,">

  <!-- Base rule for web app access logs -->
  <rule id="302000" level="0">
    <decoded_as>json</decoded_as>
    <field name="program">gunicorn</field>
    <description>TechVault web application log</description>
    <group>webapp,</group>
  </rule>

  <!-- SQL injection attempt detected in URL -->
  <rule id="302010" level="10">
    <if_sid>31100,31101,31108</if_sid>
    <url>UNION|union|SELECT|select|INSERT|insert|DROP|drop|DELETE|delete|UPDATE|update</url>
    <description>SQL injection attempt detected in URL</description>
    <group>webapp,sqli,web_attack,</group>
  </rule>

  <!-- SQL injection via single quote -->
  <rule id="302011" level="8">
    <if_sid>31100,31101,31108</if_sid>
    <url>'|%27|--|%23</url>
    <description>Potential SQL injection: special characters in URL</description>
    <group>webapp,sqli,web_attack,</group>
  </rule>

  <!-- XSS attempt -->
  <rule id="302020" level="8">
    <if_sid>31100,31101,31108</if_sid>
    <url>script|javascript|onerror|onload|eval(</url>
    <description>Cross-site scripting attempt detected</description>
    <group>webapp,xss,web_attack,</group>
  </rule>

  <!-- Command injection attempt -->
  <rule id="302030" level="12">
    <if_sid>31100,31101,31108</if_sid>
    <url>/tools/ping</url>
    <match>;|%7C|`|$(</match>
    <description>Command injection attempt via network tools</description>
    <group>webapp,command_injection,web_attack,</group>
  </rule>

  <!-- Access to sensitive files -->
  <rule id="302040" level="8">
    <if_sid>31100,31101,31108</if_sid>
    <url>.env|/debug|/backup|.git</url>
    <description>Access to sensitive file or debug endpoint</description>
    <group>webapp,information_disclosure,</group>
  </rule>

  <!-- Admin panel access -->
  <rule id="302050" level="5">
    <if_sid>31100,31101,31108</if_sid>
    <url>/admin</url>
    <description>Admin panel access</description>
    <group>webapp,admin_access,</group>
  </rule>

  <!-- Excessive 401/403 responses (brute force) -->
  <rule id="302060" level="10" frequency="10" timeframe="120">
    <if_sid>31103,31104</if_sid>
    <same_source_ip/>
    <description>Web application brute force: multiple auth failures from $(srcip)</description>
    <group>webapp,brute_force,web_attack,</group>
  </rule>

  <!-- File upload event -->
  <rule id="302070" level="5">
    <if_sid>31100,31101</if_sid>
    <url>/upload</url>
    <match>POST</match>
    <description>File upload to web application</description>
    <group>webapp,file_upload,</group>
  </rule>

  <!-- API abuse (high request rate) -->
  <rule id="302080" level="8" frequency="50" timeframe="60">
    <if_sid>31100,31101</if_sid>
    <url>/api/</url>
    <same_source_ip/>
    <description>API abuse: high request rate from $(srcip)</description>
    <group>webapp,api_abuse,</group>
  </rule>

  <!-- IDOR attempt (sequential file/user access) -->
  <rule id="302090" level="6" frequency="10" timeframe="30">
    <if_sid>31100,31101</if_sid>
    <url>/api/v1/users/|/api/v1/files/</url>
    <same_source_ip/>
    <description>Potential IDOR: sequential API resource enumeration from $(srcip)</description>
    <group>webapp,idor,web_attack,</group>
  </rule>

</group>
