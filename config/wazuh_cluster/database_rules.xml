<!-- Database Detection Rules for APTL Lab -->
<group name="aptl,database,postgresql,">

  <!-- PostgreSQL authentication failure -->
  <rule id="304000" level="5">
    <decoded_as>postgresql_log</decoded_as>
    <match>authentication failed</match>
    <description>PostgreSQL authentication failure for user $(srcuser)</description>
    <group>database,authentication_failed,</group>
  </rule>

  <!-- PostgreSQL brute force -->
  <rule id="304001" level="10" frequency="5" timeframe="120">
    <if_matched_sid>304000</if_matched_sid>
    <same_source_ip/>
    <description>PostgreSQL brute force from $(srcip)</description>
    <group>database,brute_force,</group>
  </rule>

  <!-- PostgreSQL connection from unexpected source -->
  <rule id="304010" level="8">
    <decoded_as>postgresql_log</decoded_as>
    <match>connection received</match>
    <srcip>!172.20.1.20|!172.20.2.20</srcip>
    <description>PostgreSQL connection from unexpected source: $(srcip)</description>
    <group>database,unauthorized_access,</group>
  </rule>

  <!-- PostgreSQL error indicating SQL injection -->
  <rule id="304020" level="10">
    <decoded_as>postgresql_log</decoded_as>
    <match>syntax error|unterminated quoted string|ERROR:  invalid input syntax</match>
    <description>PostgreSQL SQL error (potential injection): $(data)</description>
    <group>database,sqli,</group>
  </rule>

  <!-- Large data export (potential exfiltration) -->
  <rule id="304030" level="8">
    <decoded_as>postgresql_log</decoded_as>
    <match>COPY|pg_dump|SELECT.*FROM.*customers|SELECT.*FROM.*backup_config</match>
    <description>Large data operation on sensitive table</description>
    <group>database,data_access,exfiltration,</group>
  </rule>

  <!-- Schema modification -->
  <rule id="304040" level="10">
    <decoded_as>postgresql_log</decoded_as>
    <match>DROP TABLE|ALTER TABLE|CREATE TABLE|TRUNCATE</match>
    <description>Database schema modification detected</description>
    <group>database,schema_change,</group>
  </rule>

  <!-- Privilege escalation in database -->
  <rule id="304050" level="12">
    <decoded_as>postgresql_log</decoded_as>
    <match>GRANT|ALTER ROLE|CREATE ROLE|ALTER USER.*SUPERUSER</match>
    <description>Database privilege modification detected</description>
    <group>database,privilege_escalation,</group>
  </rule>

</group>
